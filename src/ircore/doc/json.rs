use std::io;
use crate::ircore::doc::Document;
use serde_json::Value;
use super::dir::{DirIter, ParseString};
use crate::ircore::doc::cfg::Cfg;
use std::path::Path;

pub struct JsonDocParser {
}

impl JsonDocParser {
    pub fn docs<'a>(path: &str, cfg: &'a Cfg) -> DirIter<'a> {
        DirIter::new(path, Self::parse_string, cfg)
    }
}

impl ParseString for JsonDocParser {
    fn parse_string(path: &Path, text: &str, cfg: &Cfg) -> io::Result<Document> {
        let path_string = path.to_string_lossy().to_string();
        let value: Value = serde_json::from_str(text)?;
        let mut content = String::new();
        for f in cfg.get_fields() {
            let field_name = f.to_lowercase();
            match &value[field_name] {
                Value::String(s) => {
                    content.push_str(s);
                },
                _ => (),
            }
        }
        Ok(Document::new(content, path_string.to_string()))
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_serde_json() {
        let value: Value = serde_json::from_str(r#"{"id": "659150", "url": "https://zh.wikipedia.org/wiki?curid=659150", "title": "印卡王室述评", "text": "印卡王室述评\n\n《印卡王室述评》（），一译《王家评论》，是一部有关古代南美洲印加帝国史的文献，共9卷，下分262章，作者是西班牙与印加的混血儿史家印卡·加西拉索·德拉维加（父亲是西班牙殖民者，母亲是印加王近亲），于1609年成书。\n\n《印卡王室述评》的中文译本，现今有由白凤森、杨衍永的翻译版本，由北京商务印书馆出版，书名里的「印卡」无疑就是指“Inca”（印加）。但是，白、杨两位译者认为将“Inca”译成「印加」是不妥当的，理由是这样的：\n\n「如果写成『印加』，那么按照拉丁字母书写的克丘亚语，则应写成“inga”。作者（印卡·加西拉索·德拉维加）在本书《关于秘鲁通用语的几点说明》中也明确指出，那种语言中没有西班牙语“g”这个字母。由此可见，译成『印加』是不妥当的。我们觉得，这个词的译法是个事关全局的问题，因此决定为『印卡』。」\n\n印卡·加西拉索·德拉维加创作此书的动机有三点：\n\n印卡·加西拉索·德拉维加撰史的史料来源主要有三：一是从母亲及印加故老讲授；二是自己从少在秘鲁耳闻目睹；三是引录在他之前其他西班牙人的有关印加史的著作。\n\n据美国学者普雷斯科特的观点，印卡·加西拉索·德拉维加对于印加史料的搜集，可说是在年幼时已开始。由于加西拉索在秘鲁库斯科生长，与身为印加王族的母亲居住，「年幼的加西拉索贪婪地倾听著那些敍述他的王室祖先的伟大和英武的故事，而且，尽管他当时没有用到这些故事，但他们深深地印在他的脑海中，储起来留做他日之用。\n\n及至加西拉索动笔撰写《印卡王室述评》时，才有机地搜集史料，「他写信给他那些出身印加贵族的老友和同学，搜集他在西班牙搜集不到的关于某些历史事件的进一步的材料。\n\n另外，加西拉索又相当重视同时代的其他西班牙作家的著作，因他「是在晚年著述的，是在这个故事已被卡斯提尔的作者们一再重述以后。他自然在很多地方要采用别人的说法。」\n\n《印卡王室述评》对于印加历史文化的研究提供了丰富的资料。记述了从第一代印卡王曼科·卡帕克的起源开始，中间记述十二代国王的更迭，一直讲到被西班牙人征服止，并涉及印卡的政治、经济、文化、宗教、风俗等各个方面。学者白凤森称它「对于印卡文化发展史中的各个方面都提供了丰富的第一手原始资料」，「是一关于印卡文明的文献总集和资料宝库」。而且《印卡王室述评》的史料已是硕果仅存的史料，普雷斯科特说在该书里“可以发现有关于他的国家（印加帝国）的古代史的大量真实材料，这些材料是我们从任何欧洲作者所无法获得的。”\n\n但是，《印卡王室述评》亦存在著一些缺点，普雷斯科特就指出印卡·加西拉索·德拉维加有时不免夸张失实，「由于这位印加历史学家的丰富的想像力，甚至处在黄金之地的这个王朝的巨大的物质财富也被夸大成了一片繁华似锦的神话世界。」\n《印卡王室述评》是研究印加帝国历史、文化极为重要的一部书籍。由于该书对古代印加帝国充满赞美之辞、将印加诸王的功绩当作英雄一般来叙述，因此在西班牙殖民统治秘鲁时期，殖民政府认为此书是十分危险的，将此书列为禁书。而18世纪末期的印加起义军领袖何塞·加夫列尔·孔多尔坎基，正是通过此书的内容激起了强烈的民族自豪感，号召印地安人起兵反抗西班牙的殖民统治。\n\n"}
        "#).unwrap();
        assert_eq!(value["title"], "印卡王室述评");
        match &value["none"] {
            Value::Null => assert!(true),
            Value::String(_s) => assert!(false),
            _ => assert!(false),
        }
    }

    #[test]
    fn test_parse_json_string() {
        let cfg_str = 
"file_type: json
fields:
  - id
  - url
  - title
  - text
";
        let cfg:Cfg = Cfg::from_str(cfg_str);
        let text = r#"{"id": "1", "url": "https://someurl/1", "title": "印卡王室述评", "text": "印卡王室述评\n\n《印卡王室述评》（），一译《王家评论》，是一部有关古代南美洲印加帝国史的文献，共9卷，下分262章，作者是西班牙与印加的混血儿史家印卡·加西拉索·德拉维加（父亲是西班牙殖民者，母亲是印加王近亲），于1609年成书。\n\n《印卡王室述评》的中文译本，现今有由白凤森、杨衍永的翻译版本，由北京商务印书馆出版，书名里的「印卡」无疑就是指“Inca”（印加）。但是，白、杨两位译者认为将“Inca”译成「印加」是不妥当的，理由是这样的：\n\n「如果写成『印加』，那么按照拉丁字母书写的克丘亚语，则应写成“inga”。作者（印卡·加西拉索·德拉维加）在本书《关于秘鲁通用语的几点说明》中也明确指出，那种语言中没有西班牙语“g”这个字母。由此可见，译成『印加』是不妥当的。我们觉得，这个词的译法是个事关全局的问题，因此决定为『印卡』。」\n\n印卡·加西拉索·德拉维加创作此书的动机有三点：\n\n印卡·加西拉索·德拉维加撰史的史料来源主要有三：一是从母亲及印加故老讲授；二是自己从少在秘鲁耳闻目睹；三是引录在他之前其他西班牙人的有关印加史的著作。\n\n据美国学者普雷斯科特的观点，印卡·加西拉索·德拉维加对于印加史料的搜集，可说是在年幼时已开始。由于加西拉索在秘鲁库斯科生长，与身为印加王族的母亲居住，「年幼的加西拉索贪婪地倾听著那些敍述他的王室祖先的伟大和英武的故事，而且，尽管他当时没有用到这些故事，但他们深深地印在他的脑海中，储起来留做他日之用。\n\n及至加西拉索动笔撰写《印卡王室述评》时，才有机地搜集史料，「他写信给他那些出身印加贵族的老友和同学，搜集他在西班牙搜集不到的关于某些历史事件的进一步的材料。\n\n另外，加西拉索又相当重视同时代的其他西班牙作家的著作，因他「是在晚年著述的，是在这个故事已被卡斯提尔的作者们一再重述以后。他自然在很多地方要采用别人的说法。」\n\n《印卡王室述评》对于印加历史文化的研究提供了丰富的资料。记述了从第一代印卡王曼科·卡帕克的起源开始，中间记述十二代国王的更迭，一直讲到被西班牙人征服止，并涉及印卡的政治、经济、文化、宗教、风俗等各个方面。学者白凤森称它「对于印卡文化发展史中的各个方面都提供了丰富的第一手原始资料」，「是一关于印卡文明的文献总集和资料宝库」。而且《印卡王室述评》的史料已是硕果仅存的史料，普雷斯科特说在该书里“可以发现有关于他的国家（印加帝国）的古代史的大量真实材料，这些材料是我们从任何欧洲作者所无法获得的。”\n\n但是，《印卡王室述评》亦存在著一些缺点，普雷斯科特就指出印卡·加西拉索·德拉维加有时不免夸张失实，「由于这位印加历史学家的丰富的想像力，甚至处在黄金之地的这个王朝的巨大的物质财富也被夸大成了一片繁华似锦的神话世界。」\n《印卡王室述评》是研究印加帝国历史、文化极为重要的一部书籍。由于该书对古代印加帝国充满赞美之辞、将印加诸王的功绩当作英雄一般来叙述，因此在西班牙殖民统治秘鲁时期，殖民政府认为此书是十分危险的，将此书列为禁书。而18世纪末期的印加起义军领袖何塞·加夫列尔·孔多尔坎基，正是通过此书的内容激起了强烈的民族自豪感，号召印地安人起兵反抗西班牙的殖民统治。\n\n"}
        "#;
        if let Ok(doc) = JsonDocParser::parse_string(Path::new("some path"), text, &cfg){
            let c = doc.get_content();
            assert!(c.len() > 0);
            assert_eq!(doc.get_path(), "some path");
        }
    }

}